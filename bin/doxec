#!/usr/bin/env python3

import argparse
import doxec
import sys

if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="""
        Run code examples written in a documentation file to ensure the
        validity of the examples.
        """)

    parser.add_argument("--syntax", choices=doxec.parser.keys(),
        default="markdown",
        help="The syntax parser to be used for the listed files.")

    parser.add_argument("documents", metavar="DOCUMENT", nargs="+", default=[],
        help="A document from which the code examples should be parsed and "
            "executed")

    args = parser.parse_args()

    parser = doxec.parser[args.syntax]

    def monitor(op, exception):
        print("running %s(%s) ... " % (op.command, op.args))
        if exception is not None:
            print(chr(27) + "[31m", end="")
            print(exception, end="")
            print(chr(27) + "[0m")

    fail_count = 0
    for doc_path in args.documents:
        doc = doxec.Document(doc_path, syntax=parser)
        fail_count += not doc.run(monitor=monitor)

    sys.exit(fail_count)
